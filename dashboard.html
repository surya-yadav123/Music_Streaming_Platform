<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - Music On</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-primary">ðŸŽ¶ Music On Dashboard</h2>
      <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>

    <!-- Welcome and Playlist Creation -->
    <div class="card shadow p-4 mb-4">
      <h4 id="welcome" class="text-success mb-3"></h4>
      <div class="mb-3">
        <label for="playlistName" class="form-label fw-bold">Create a New Playlist</label>
        <div class="input-group">
          <input id="playlistName" type="text" class="form-control" placeholder="Enter playlist name">
          <button class="btn btn-primary" onclick="createPlaylist()">Create</button>
        </div>
      </div>
      <div id="playlistMessage" class="text-info"></div>
    </div>

    <!-- Playlist List -->
    <div class="card shadow p-4 mb-4">
      <h4>Your Playlists</h4>
      <ul id="playlistList" class="list-group"></ul>
    </div>

    <!-- Tracks Section -->
    <div class="card shadow p-4">
      <h4>ðŸŽµ Available Tracks</h4>
      <div id="trackList" class="list-group"></div>
      <div id="trackMessage" class="mt-2 text-info"></div>
    </div>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) window.location.href = '/';
    document.getElementById('welcome').innerText = 'Hello, ' + user.name;

    function logout() {
      localStorage.removeItem('user');
      alert('Logged out successfully!');
      window.location.href = '/';
    }

    // âœ… Create Playlist
    async function createPlaylist() {
      const playlistName = document.getElementById('playlistName').value.trim();
      const message = document.getElementById('playlistMessage');
      if (!playlistName) return message.innerText = "Please enter a playlist name.";

      const res = await fetch('/api/playlists/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: playlistName, user: { email: user.email } })
      });

      const text = await res.text();
      message.innerText = text;
      if (res.ok) {
        document.getElementById('playlistName').value = '';
        loadPlaylists();
      }
    }

    // âœ… Load Playlists
    async function loadPlaylists() {
      const list = document.getElementById('playlistList');
      list.innerHTML = '';
      const res = await fetch(`/api/playlists/user/${user.email}`);
      if (res.ok) {
        const playlists = await res.json();
        window.playlists = playlists;
        playlists.forEach(p => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `${p.name} <span class="badge bg-primary">${p.tracks.length} tracks</span>`;
          list.appendChild(li);
        });
      } else {
        list.innerHTML = '<li class="list-group-item text-danger">Failed to load playlists</li>';
      }
    }

    // âœ… Load Tracks
    async function loadTracks() {
      const trackList = document.getElementById('trackList');
      trackList.innerHTML = '';
      const res = await fetch('/api/tracks');
      if (res.ok) {
        const tracks = await res.json();
        tracks.forEach(track => {
          const div = document.createElement('div');
          div.className = 'list-group-item';
          div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${track.title}</strong> â€” ${track.artist}
                <button class="btn btn-outline-primary btn-sm ms-3" onclick="playTrack('${track.filename}')">â–¶ Play</button>
              </div>
              <div>
                <select class="form-select form-select-sm d-inline w-auto" id="playlistSelect-${track.id}">
                  <option value="">Select Playlist</option>
                  ${window.playlists.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                </select>
                <button class="btn btn-sm btn-success ms-2" onclick="addToPlaylist(${track.id})">Add</button>
                <button class="btn btn-sm btn-danger ms-2" onclick="removeFromPlaylist(${track.id})">Remove</button>
              </div>
            </div>
          `;
          trackList.appendChild(div);
        });
      } else {
        trackList.innerHTML = '<div class="text-danger">Failed to load tracks</div>';
      }
    }

    // âœ… Play Track using Spring Boot mapped URL
    function playTrack(filename) {
      const audioUrl = `/music/${filename}`;  
      const audio = new Audio(audioUrl);
      audio.play().catch(err => alert('Cannot play this file: ' + err.message));
    }

    // âœ… Add / Remove Track from Playlist
    async function addToPlaylist(trackId) {
      const playlistId = document.getElementById(`playlistSelect-${trackId}`).value;
      const msg = document.getElementById('trackMessage');
      if (!playlistId) return msg.innerText = "Select a playlist first!";
      const res = await fetch(`/api/playlists/${playlistId}/addTrack/${trackId}`, { method: 'POST' });
      msg.innerText = await res.text();
      if (res.ok) loadPlaylists();
    }

    async function removeFromPlaylist(trackId) {
      const playlistId = document.getElementById(`playlistSelect-${trackId}`).value;
      const msg = document.getElementById('trackMessage');
      if (!playlistId) return msg.innerText = "Select a playlist first!";
      const res = await fetch(`/api/playlists/${playlistId}/removeTrack/${trackId}`, { method: 'DELETE' });
      msg.innerText = await res.text();
      if (res.ok) loadPlaylists();
    }

    // âœ… Initial load
    (async () => {
      await loadPlaylists();
      await loadTracks();
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
